language: nix

# Do not spam me with build status emails.
notifications:
  email: false

cache:
  directories:
    - $HOME/.stack
    - .stack-work
    - app/.psc-package

before_cache:
  # The Stack database changes even when no code changes, do not cache it.
  - rm $HOME/.stack/stack.sqlite3

before_install:
  # Bring all the tools from the pinned build environment into the PATH.
  - export devenv_path=$(nix-build --no-out-link)
  - export PATH=${devenv_path}/bin:$PATH
  - export LIBRARY_PATH=${devenv_path}/lib:$LIBRARY_PATH

  # Binaries in the profile built above may need locales, that they can't find
  # unless we point LOCALE_ARCHIVE at the archive that contains them.
  - export LOCALE_ARCHIVE=${devenv_path}/lib/locale/locale-archive

script:
  # Build the Haskell server-side app.
  - stack build --no-terminal

  # Build the PureScript client-side app.
  - make -C app

  # Export the species catalog, and pipe it through jq. This verifies that we
  # can parse all toml files, printing the erros if that fails. If it succeeds,
  # we would get a big json blob in the CI logs, so instead pipe it to /dev/null.
  - stack exec --no-terminal sempervivum -- export-species > /dev/null
